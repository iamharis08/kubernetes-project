# authorization-policies-fixed.yaml

# --- 1. Allow API Gateway to call PHI Service ---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-api-gateway-to-phi-service
  namespace: default
spec:
  selector:
    matchLabels:
      app: phi-service  # Apply to phi-service pods
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/api-gateway-sa"]
    to:
    - operation:
        methods: ["GET"]

---

# --- 2. Allow PHI Service to call Audit Service ---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-phi-service-to-audit-service
  namespace: default
spec:
  selector:
    matchLabels:
      app: audit-service  # Apply to audit-service pods
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/default/sa/phi-service-sa"]
    to:
    - operation:
        methods: ["POST"]

---

# --- Notes ---
# 1. Default Istio behavior is DENY, so only the above traffic is allowed.
# 2. api-gateway GET → phi-service GET /patient/{id} is allowed.
# 3. phi-service POST → audit-service /log is allowed.
# 4. All other pod-to-pod traffic in 'default' namespace is denied.
